<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>QYAOE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,shrink-to-fit=no">
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="css/pagination.css" />
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="js/pagination.js"></script>
    <script type="text/javascript" src="js/datatables.min.js"></script>
</head>
<style>

:root{
	--p1color:#394EF8;
	--p2color:#FF001B;
	--p3color:#03FF2E;
	--p4color:#FFFF37;
	--p5color:#03FFFD;
	--p6color:#FF4BA9;
	--p7color:#6E6E6E;
	--p8color:#FF8B25;
}
.grid-container-team {
	display: grid;
	grid-template-columns: 30px 150px 30px 60px 40px 60px;
	align-items: center;
  }
.player {
	font-size:larger;
	border-radius: 50%;
	height: 25px;
 	width: 25px;
	min-width: 25px;
	min-height: 25px;
	text-align: center;
	top: 50%;
  line-height: 25px;
}
.p1 {
	background-color: var(--p1color);
	font-size: x-large;
}

.p2 {
	background-color: var(--p2color);
	font-size: x-large;
}

.p3 {
	background-color: var(--p3color);
	font-size: x-large;
	color: #008917
}

.p4 {
	background-color: var(--p4color);
	font-size: x-large;
	color: #938200;
}

.p5 {
	background-color: var(--p5color);
	font-size: x-large;
	color: #028C8B
}

.p6 {
	background-color: var(--p6color);
	font-size: x-large;
}

.p7 {
	background-color: var(--p7color);
	font-size: x-large;
}

.p8 {
	background-color: var(--p8color);
	font-size: x-large;
}

.team-input{
  width: 40px;
}
.victor {
	color: #f8fc05;
}

</style>
<body class="bg-dark">
  <main>
  <script src="js/bootstrap.bundle.min.js"></script>
<div class="container py-5">   
  <nav class="navbar navbar-dark navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand text-white" href="index.html">QingY帝国</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link text-white" href="index.html">QY看板</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="qycs.html">QY4v4</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="md.html">资源</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <br>
     
      
    
    
  
</nav>
<div class="tab-pane fade show active" id="nav-players" role="tabpanel" aria-labelledby="nav-players-tab">
  <div class="text-muted"><p><span class="navbar-text" id="games"></span> 
    <span class="navbar-text">局比赛从<input  type="text" id="numb1">至<input  type="text" id="numb2">
    <button class="btn btn-primary btn-sm" type="button" onclick="myFunction()">提交</button> 
    <button class="btn btn-primary btn-sm"  id="numb24" value = "1" type="button" onclick="myFunctiondate24()">24小时</button>
    <button class="btn btn-primary btn-sm"  id="numb7" value = "7" type="button" onclick="myFunctiondate7()">一周</button>
    <button class="btn btn-primary btn-sm"  id="numb30" value = "30" type="button" onclick="myFunctiondate30()">30天</button>
    <button class="btn btn-primary btn-sm"  id="numb90" value = "90" type="button" onclick="myFunctiondate90()">90天</button>
    <button class="btn btn-info btn-sm"  id="numb1" value = "Arabia" type="button" onclick="myalb()">阿拉伯</button>
    <button class="btn btn-info btn-sm"  id="numb21" value = "Arena" type="button" onclick="myjjc()">竞技场</button>
    <button class="btn btn-info btn-sm"  id="numb22" value = "Arena" type="button" onclick="myym()">游牧</button>
    <button class="btn btn-info btn-sm"  id="numb23" value = "Arena" type="button" onclick="myfl()">菲林</button>
    <button class="btn btn-info btn-sm"  id="numb26" value = "Arena" type="button" onclick="myzczc()">藏身之处</button>
    <button class="btn btn-info btn-sm"  id="numb28" value = "Arena" type="button" onclick="mygcy()">干草原</button>
    <button class="btn btn-info btn-sm"  id="numb29" value = "Arena" type="button" onclick="myfwsq()">符文石群</button>
  </span></p></div> <div class="completedgames text-muted"></div>
   
<table id="leaderboard-table" class="table table-dark table-striped">
      <thead class="table-head2">
        <tr>
        <th scope="col" class="left-align light-weight">昵称</th>
        
        <th scope="col" class="left-align light-weight">[QingY]初Elo</th>
        <th scope="col" class="left-align light-weight">[QingY]等级</th>
        
        <th scope="col" class="left-align light-weight">Elo变化</th>
        <th scope="col" class="left-align light-weight">群局数</th>
        <th scope="col" class="left-align light-weight">胜利数</th>
        <th scope="col" class="left-align light-weight">失败数</th>
        <th scope="col" class="left-align light-weight">连胜/败</th>
        <th scope="col" class="left-align light-weight">最多连胜/败</th>
        <th scope="col" class="left-align light-weight">胜败比率</th>
        </tr>
      </thead>
      <tbody class="player-table-body">
      </tbody>
</table>
</div>


  <h3 class="text-muted text-center">QY4V4的游戏</h3>
  <div class="live-game">
  
  </div>
  
  <div class="recently-completed-games"></div>
  <div class="live-game"></div>
  <div id="pagination-container" class="live-game"></div>
  


 
<footer class="pt-3 mt-4 text-white border-top">
  <p class="small">
    <a class="link-light" href="https://moloo.gitee.io/qyaoe/qycs.html"  target="_blank" rel="noopener norefferrer">Qy游戏记录</a> |
      <a class="link-light" href="https://space.bilibili.com/452395918/channel/collectiondetail?sid=850678"  target="_blank" rel="noopener norefferrer">Qy视频</a> |
      <a class="link-light" href="https://www.ageofempires.com/games/aoeiide/"  target="_blank" rel="noopener norefferrer">微软帝国</a> |
      <a class="link-light" href="https://aoe2recs.com/dashboard/"  target="_blank" rel="noopener norefferrer">观看板</a> |
      <a class="link-light" href="https://aoe2companion.com/"  target="_blank" rel="noopener norefferrer">AoE II Companion</a> |
      <a class="link-light" href="https://www.aoezone.net/"  target="_blank" rel="noopener norefferrer">Aoezone论坛</a> |
      <a class="link-light" href="https://liquipedia.net/ageofempires/Main_Page"  target="_blank" rel="noopener norefferrer">比赛记录</a> |
      <a class="link-light" href="https://www.aoe2insights.com/"  target="_blank" rel="noopener norefferrer">录像分析</a> |
      <a class="link-light" href="https://aoe2techtree.net/"  target="_blank" rel="noopener norefferrer">科技树</a> | 
      <a class="link-light" href="https://siegeengineers.org/"  target="_blank" rel="noopener norefferrer">开发社区</a> |
      <a class="link-light" href="https://aoe2cm.net/"  target="_blank" rel="noopener norefferrer">禁(Ban)和选(Pick)</a> |
      <a class="link-light" href="https://kook.top/A7YVBl"  target="_blank" rel="noopener norefferrer">QY语音KOOK</a>|
    <a class="link-light" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener norefferrer">CC BY-SA 4.0</a> |
     <a class="text-white" href="https://github.com/moloo2050/qy" target="_blank" rel="noopener norefferrer">GitHub</a>|
     <a class="text-white" href="https://www.aoe2database.com/" target="_blank" rel="noopener norefferrer">数据网</a></p>
  <p class="small">Age of Empires II DE © Microsoft Corporation. Age of QYAOE was created under Microsoft's 
    <a class="text-white" href="https://www.xbox.com/en-us/developers/rules" target="_blank" rel="noopener norefferrer">"Game Content Usage Rules"</a> using assets from Age of Empires II DE, and it is not endorsed by or affiliated with Microsoft.</p>
</footer> 
</div> 
</main>  
<script>
    
let ens =[]
let civs=[]
let maps=[]
let matchs=[]
let QYprofile_ids=[]
let playerdata = []
let obj =[]
let matches=[]
let QYmatchs=[]
let matchids=[]
let upmatches=[]
let newmatches=[]
let maptypes =[]
let players=[]
let tplayers=[]
let tmatches=[]
function getqyteable(){
  profile_ids = [] 
  QYprofile_ids=[]
  playerdata = []
  obj =[]
  matches=[]
  QYmatchs=[]
  tplayers=[]
  tmatches=[]
  players =[]
  const url = 'https://app.teable.cn/api/table/tblNAl03pcmuuM78OMc/record?cellFormat=json&fieldKeyType=name&filterByTql=%7Bfield%7D%20%3D%20%27Completed%27%20AND%20%7Bfield%7D%20%3E%205&take=200&skip=0';
  const url2 = 'https://app.teable.cn/api/table/tbli6tAxyEx2piskldF/record?cellFormat=json&fieldKeyType=name&viewId=viwcrfVLNvWXGDuWiEC&filterByTql=%7Bfield%7D%20%3D%20%27Completed%27%20AND%20%7Bfield%7D%20%3E%205&take=1000&skip=2000';
  const url3 = 'https://app.teable.cn/api/table/tbli6tAxyEx2piskldF/record?cellFormat=json&fieldKeyType=name&viewId=viwcrfVLNvWXGDuWiEC&filterByTql=%7Bfield%7D%20%3D%20%27Completed%27%20AND%20%7Bfield%7D%20%3E%205&take=1000&skip=0';
  const url4 = 'https://app.teable.cn/api/table/tbli6tAxyEx2piskldF/record?cellFormat=json&fieldKeyType=name&viewId=viwcrfVLNvWXGDuWiEC&filterByTql=%7Bfield%7D%20%3D%20%27Completed%27%20AND%20%7Bfield%7D%20%3E%205&take=1000&skip=1000';
  const options = {method: 'GET', headers: {Authorization: 'Bearer teable_acc6TG3GbDXIOzfr3pS_99GCvZ9joUOxXwi3rF+nVgmt2TfsJMo4ABEioeKwP6c='}};
  
  try {
    const response =  fetch(url, options)
    .then(function(response) {
      return response.json();
    })
    .then(function(playersJson) {
  
      playersJson.records.forEach((p)=>{
        p.fields.newqrating=p.fields.qrating
        p.fields.id=p.id
        p.fields['on']=null
        obj.push(p.fields)
        if(p.fields.status!=3){
          QYprofile_ids.push(p.fields['profile_id'])
        }
        if(p.fields.status!=3 && p.fields.status!=2){
          players.push(p.fields['profile_id'])
        }
        tplayers.push({profile_id:p.fields.profile_id,name:p.fields.name,games:0,wins:0,qrating:0,newqrating:0,elo:0})
      })
      
      console.log(obj);
      const response2 =  fetch(url2, options).then(function(response) {
        return response.json();
      }).then(function( matchesJson) {
        const response3 =  fetch(url3, options).then(function(response) {
          return response.json();
        }).then(function( matchesJson1) {
          const response4 =  fetch(url4, options).then(function(response) {
            return response.json();
          }).then(function( matchesJson2) {

        matchesJson.records.forEach((m)=>{
          m.fields.matchinfo=JSON.parse(m.fields.matchinfo)
          m.fields.matchinfo.teableid=m.id
          matchs.push(m.fields.matchinfo)
          
        })
        matchesJson1.records.forEach((m)=>{
          m.fields.matchinfo=JSON.parse(m.fields.matchinfo)
          m.fields.matchinfo.teableid=m.id
          matchs.push(m.fields.matchinfo)
          
        })
        matchesJson2.records.forEach((m)=>{
          m.fields.matchinfo=JSON.parse(m.fields.matchinfo)
          m.fields.matchinfo.teableid=m.id
          matchs.push(m.fields.matchinfo)
          
        })
        matchs.sort(function(a, b){return a.match_id - b.match_id})
        console.log(matchs);
        
        matchs.forEach((match) => {
          matchids.push(match.match_id)
        })
        playerdata=obj
        playerdata.sort(function(a, b){return b.date-a.date})
        obj.forEach((player) => { 
              player['newqrating'] =player['qrating']
              profile_ids.push(player['profile_id'])
              if(player.status==1 || player.status==5 || player.status==3 || player.status==2){
                QYprofile_ids.push(player['profile_id'])
              }
              if(player.status==1 || player.status==4 || player.status==5){
              
              
            document.querySelector('.player-table-body').insertAdjacentHTML("beforeend",`<tr id = ${player['profile_id']}>
          <td scope="row" class="left-align player-name leaderboard-player" style="width: 220px"><a class="link-light" href='qy.html?id=${player.profile_id}' target="_blank" rel="noopener norefferrer">${player['name']}</a></td>
          
          <td class="leaderboard-elo"><span id = pidcr${player['profile_id']}>${player['qrating']}</td>  
          
          <td class="leaderboard-elo"><span id = pidr${player['profile_id']}>${player['newqrating']}</td>
          <td class="leaderboard-elo"><span id = pidelo${player['profile_id']}>0</td>
          <td class="leaderboard-elo"><span id = games${player['profile_id']}>${player['games']}</span></td>
          <td class="leaderboard-elo"><span id = wins${player['profile_id']}>${player['wins']}</span></td>
          <td class="leaderboard-elo"><span id = loses${player['profile_id']}>${player['loses']}</span></td>
          <td class="leaderboard-elo"><span id = streak${player['profile_id']}>${player['streak']}</span></td>
          <td class="leaderboard-elo"><span id = streakest${player['profile_id']}>${player['streakest']}</span></td>
          <td class="leaderboard-elo"><span id = wl${player['profile_id']}>0%</span></td>
        </tr>`
        );}
    })
            console.info(obj);
            
            matchs.sort(function(a, b){return a.match_id - b.match_id}) 
            insertLiveGames (matchs)
            LiveGames (matchs)
            
            
        }).then(function() {
          //getnewmatches(profile_ids,1)
          //getunrankmatches(profile_ids)
          
$('#leaderboard-table').DataTable({
   "autoWidth": false,
    "searching": false, 
    "destroy": true,  
    "paging": false,
    "order": [[9, 'desc'], [2, 'desc']],
} ); 
      })
    })
  })
})
  } catch (error) {
    console.error(error);
  }
  }
getqyteable()
    
    // 方法传入两个数组，第一个数组为key，第二个数组对应位置为value，此方法在Python中为zip()函数。
    const ArraytoObj = (keys = [], values = []) => {
        if (keys.length === 0 || values.length === 0) return {};
        const len = keys.length > values.length ? values.length : keys.length;
        const obj = {};
        for (let i = 0; i < len; ++i) {
            obj[keys[i]] = values[i]
        }
        return obj;
    };

   

function fs(profile_id){
  
    let a= obj.find((ele) => {
          return ele.profile_id==profile_id})
    if (a==undefined){
      return 1600
    }
    else{
      return a
    }
}
function timeElapsed (Time) {
      const timeElapsed = Math.floor(Time/60)
      
     if (timeElapsed>1440){
     var l = Math.floor(timeElapsed/1440)
     var k = timeElapsed-l*1440
     var j = k%60;
     k = Math.floor(k/60)
     return l+"天"+k+"小时"+j+"分钟";
    }
    else if (timeElapsed<=1440 && timeElapsed>60) {
     var	j = timeElapsed%60;
     var  h = Math.floor(timeElapsed/60)
     return h+"小时"+j+"分钟";
    }
    else if(timeElapsed<=60){
      return timeElapsed+"分钟";
    }  
  }  
  
async function getMatch(matchid) {
    const response = await (await fetch(`https://aoe2.net/api/match?game=aoe2de&match_id=${matchid}`)).json()
    let Matches = response
    console.log('match', Matches)

    return Matches
  }
let newmatch =0  

function matchOutcome(player) {
      if(player['won'] === null) {
        return ""
      } else if (player['won'] === true){
        return '<span class="victor"><i class="fa-solid fa-crown "></i></span>'
      } else {
        return ""
      }
  }
function countryCheck(country) {
      if (country == null) {
        console.log('undefined country', country)
        return `https://aoe2gb.s3.eu-west-2.amazonaws.com/images/Flags/undefined.png`
      } else {
        return `https://aoe2gb.s3.eu-west-2.amazonaws.com/images/Flags/${country.toLowerCase()}.png`
      }
  }

function matchelo(player,a,b,kFactor = 32) {
      if(player['won'] === null) {
        return [0,0]
      } else if (player['won'] === true){
        return elo([a,b],[1,0],kFactor)
      } else {
        return elo([b,a],[0,1],kFactor)
      }
  }

const elo = ([a, b], [c,d],kFactor = 32) => {
  const expectedScore = (self, opponent) => 1 / (1 + 10 ** ((opponent - self) / 400));
  const newRating = (rating, i) => kFactor * (i - expectedScore(i ? a : b, i ? b : a));
  return [Math.round(newRating(a, c)/4), Math.round(newRating(b, d)/4)];
};
function sortAndSplitPlayersIntoTeams(gbMatch) {
    
    let allPlayers = gbMatch['teams']
    
    let team1 = gbMatch['teams'][0]
    let team2 = gbMatch['teams'][1]
    
    team1.sort((a, b) => a['color']-b['color'])
    team2.sort((a, b) => a['color']-b['color'])
    return [team1, team2]
  }



  function LiveGames (pastGbMatches) {
    
    
    document.querySelector('.completedgames').innerHTML="<p>从"+new Date(pastGbMatches[0]['started']).toLocaleDateString()+"至"+new Date(pastGbMatches[pastGbMatches.length-1]['started']).toLocaleDateString()+"局数("+ pastGbMatches.length+")"+"</p>"
    pastGbMatches.sort(function(a, b){return b.match_id - a.match_id})
       var sources = pastGbMatches
       var options = {
       dataSource: sources,
       pageSize:3,
       className: 'paginationjs-theme-blue paginationjs-big',
      callback: function (response, pagination) {
        window.console && console.log(response, pagination);
        var dataHtml = '';
        $.each(response, function (index, match) {
        const teams = match['teams']
        const team1 = teams[0]
        const team2 = teams[1]
        const team1Player1 = teams[0][0]
        const team1Player2 = teams[0][1]
        const team1Player3 = teams[0][2]
        const team1Player4 = teams[0][3]
        const team2Player1 = teams[1][0]
        const team2Player2 = teams[1][1]
        const team2Player3 = teams[1][2]
        const team2Player4 = teams[1][3]
        let team1EloAvg = 0
        let team2EloAvg = 0 
        team1.forEach((player) =>  {team1EloAvg += Number(player.qrating)
         
        })
        team1.sort(function(a, b){return a.color - b.color})
        team2.forEach((player) =>  {team2EloAvg += Number(player.qrating)
          
        })
        team2.sort(function(a, b){return a.color - b.color})
        let timestart = Math.floor(match['started'])
        var timegame =  Math.round((new Date(match['finished']).getTime()-new Date(match['started']).getTime())*1.7/60000)
        var net= `<a class="spectate-btn" href="https://www.aoe2insights.com/match/${match['match_id']}/analysis/" target="_blank" rel="noopener norefferrer">录像分析</a></p>`
        if (match['teams'].length == 0){
          
        } else if(match['teams'].length == 2) {
        var team1txt =""
        var team2txt =""
        for (i in team1){
          team1txt +=
          `<div class="team-game-player grid-container-team">
          <p class="player p${team1[i]['color']}">${team1[i]['color']}</p>
          <p class="player-name"> ${fs(team1[i].profile_id)['name']}</p>
          <p><img src="Civs/${team1[i]['civ_name'].toLowerCase()}.png"  class="rounded-circle" width="30"></p>
          <p>${team1[i]['qrating']}</p>
          <p>(${team1[i]['qelo']})</p>
          <p>${team1[i]['newqrating']}</p>
        </div>`
        }
        for(j in team2){
          team2txt +=
          `<div class="team-game-player grid-container-team ">
          <p class="player p${team2[j]['color']}">${team2[j]['color']}</p>
          <p class="player-name"> ${fs(team2[j].profile_id)['name']}</p>
          <p><img src="Civs/${team2[j]['civ_name'].toLowerCase()}.png" class="rounded-circle" width="30"></p>
          <p>${team2[j]['qrating']}</p>
          <p>(${team2[j]['qelo']})</p>
          <p>${team2[j]['newqrating']}</p>
        </div>`
        }
        dataHtml +=`
        <div class="card shadow-sm">
        <div class="card-body">
        <div class="row">
          <div class="col">
            <h4 class="text-center">Team 1${matchOutcome(team1Player1)}</h4>
            ${team1txt}
          </div>
        <div class="col">
            <h4 class="text-center">Team 2${matchOutcome(team2Player1)}</h4>
           ${team2txt}
          </div>
      </div>
      <hr>
        <div class="row">
          <div class="col">
            <p class="text-center">${match['map_name']} ${team1EloAvg}||${team2EloAvg}</p>
          </div>
          <div class="col">
            <small class="text-muted">${new Date(match['started']).toLocaleString()}游戏时长 ${Math.round((new Date(match['finished']).getTime()-new Date(match['started']).getTime())*1.7/60000)} 分  ${net}</small>
            
          </div>
          <hr>
        </div></div></div>`
      }
      });
        $('#pagination-container').prev().html(dataHtml);
      }
    };

    //$.pagination(container, options);

    
    $('#pagination-container').pagination(options); 

     
    
  }
  function insertLiveGames (pastGbMatches) {
    
      
  pastGbMatches.forEach((match) =>  {
        let team1EloAvg = 0
        let team2EloAvg = 0 
        let team1Elo = 0
        let team2Elo = 0
        const teams = match['teams']
        const team1 = teams[0]
        const team2 = teams[1]
        const team1Player1 = match['teams'][0][0]
        const team1Player2 = match['teams'][0][1]
        const team1Player3 = match['teams'][0][2]
        const team1Player4 = match['teams'][0][3]
        const team2Player1 = match['teams'][1][0]
        const team2Player2 = match['teams'][1][1]
        const team2Player3 = match['teams'][1][2]
        const team2Player4 = match['teams'][1][3]
        if ( (new Date(match['finished']).getTime()-new Date(match['started']).getTime())<600000  || team1Player1.won==null ) {
          team1.forEach((player) =>  { 
          if(fs(player.profile_id).status==2){
                player.profile_id = fs(player.profile_id).qrating
            }

            player.qrating=Number(fs(player.profile_id).newqrating),
            player.qelo=0,
            player.newqrating=Number(fs(player.profile_id).newqrating)})

            team2.forEach((player) =>  { 
          if(fs(player.profile_id).status==2){
                player.profile_id = fs(player.profile_id).qrating
            }
            player.qrating=Number(fs(player.profile_id).newqrating),
            player.qelo=0,
            player.newqrating=Number(fs(player.profile_id).newqrating)})


    } else {
       
        
        team1.forEach((player) =>  { 
          if(fs(player.profile_id).status==2){  
            player.profile_id = fs(player.profile_id).qrating
            team1EloAvg += Number(fs(player.profile_id).newqrating)
            
            
            }else{
            team1EloAvg += Number(fs(player.profile_id).newqrating)
            
            
          }
          })
        team2.forEach((player) =>  {
          if(fs(player.profile_id).status==2){
                player.profile_id = fs(player.profile_id).qrating
                team2EloAvg += Number(fs(player.profile_id).newqrating)
                
            }else{
            team2EloAvg += Number(fs(player.profile_id).newqrating)
            }
            
         })
     
     
        
        
        if(match.match_id>192540768){
        let elo = matchelo(team1Player1,team1EloAvg,team2EloAvg,128)
        team1Elo = Number(elo[0])
        team2Elo = Number(elo[1])
        team1.forEach((player) =>  { 
         
          if(team1Elo>=0){
           
           player.qelo=Number((team1Elo*4*(fs(player.profile_id).newqrating/team1EloAvg)).toFixed(0))
           
           player.qrating=Number(fs(player.profile_id).newqrating),
           player.newqrating=Number(fs(player.profile_id).newqrating+player.qelo)
          }else if(team1Elo<0){
           player.qelo=Number((team1Elo*4*(fs(player.profile_id).newqrating/team1EloAvg)).toFixed(0))
           player.qrating=Number(fs(player.profile_id).newqrating),
           player.newqrating=Number(fs(player.profile_id).newqrating+player.qelo)
          }
          fs(player.profile_id).newqrating=player.newqrating
        })
        team2.forEach((player) =>  {
           
            if(team2Elo>=0){
           player.qelo=Number((team2Elo*4*(fs(player.profile_id).newqrating/team2EloAvg)).toFixed(0))
           player.qrating=Number(fs(player.profile_id).newqrating),
           player.newqrating=Number(fs(player.profile_id).newqrating+player.qelo)
          }else if(team2Elo<0){
           player.qelo=Number((team2Elo*4*(fs(player.profile_id).newqrating/team2EloAvg)).toFixed(0))
           player.qrating=Number(fs(player.profile_id).newqrating),
           player.newqrating=Number(fs(player.profile_id).newqrating+player.qelo)
          }
          fs(player.profile_id).newqrating=player.newqrating
        })
      }
      else{
        let elo = matchelo(team1Player1,team1EloAvg,team2EloAvg)
        team1Elo = Number(elo[0])
        team2Elo = Number(elo[1])
        team1.forEach((player) =>  { 
         
         
          player.qelo=Number(team1Elo)
          player.qrating=Number(fs(player.profile_id).newqrating),
          player.newqrating=Number(fs(player.profile_id).newqrating+player.qelo)
         
         fs(player.profile_id).newqrating=player.newqrating
       })
       team2.forEach((player) =>  {
          
       
          player.qelo=Number(team2Elo)
          player.qrating=Number(fs(player.profile_id).newqrating),
          player.newqrating=Number(fs(player.profile_id).newqrating+player.qelo)
         
         fs(player.profile_id).newqrating=player.newqrating
       })

      }
        let team1won = 0
        let team2won = 0
        let team1streak =0
        let team2streak =0

        if (team1[0].won==true){
          team1won = 1
          team2won = 0
          team1streak =1
          team2streak =-1
        }
        else if(team1[0].won==false)
        {
          team1won = 0
          team2won = 1
          team1streak =-1
          team2streak =1
        }
        else{
          team1won = 0
          team2won = 0
          team1streak =0
          team2streak =0
        }
        team1.forEach((player) => {
          if ((fs(player.profile_id).streak>=0 && team1streak==1) || (fs(player.profile_id).streak<=0 && team1streak==-1) ){
            fs(player.profile_id).streak += team1streak
            
          }
          else if ((fs(player.profile_id).streak>=0 && team1streak==-1) || (fs(player.profile_id).streak<=0 && team1streak==1) ){
            fs(player.profile_id).streak = team1streak
          }
          if (Math.abs(fs(player.profile_id).streak) >= Math.abs(fs(player.profile_id).streakest )){
            fs(player.profile_id).streakest = fs(player.profile_id).streak
          }
        

         
          fs(player.profile_id).wins+=team1won,
          fs(player.profile_id).loses+=team2won,
          fs(player.profile_id).games=fs(player.profile_id).wins+fs(player.profile_id).loses
         
        })
        team2.forEach((player) =>  {
          if ((fs(player.profile_id).streak>=0 && team2streak==1 )|| (fs(player.profile_id).streak<=0 && team2streak==-1 )){
            fs(player.profile_id).streak += team2streak
          }
          else if ((fs(player.profile_id).streak>=0 && team2streak==-1) || (fs(player.profile_id).streak<=0 && team2streak==1) ){
            fs(player.profile_id).streak = team2streak
          }
          if (Math.abs(fs(player.profile_id).streak) >= Math.abs(fs(player.profile_id).streakest )){
            fs(player.profile_id).streakest = fs(player.profile_id).streak
          }
         
         
          fs(player.profile_id).wins+=team2won,
         
          fs(player.profile_id).loses+=team1won,
        
          fs(player.profile_id).games=fs(player.profile_id).wins+fs(player.profile_id).loses
        
        })
      }      
    })

    obj.forEach((player) => { if(player.status==1 || player.status==4 || player.status==5){

          
          $("#pidr"+player.profile_id).html(fs(player.profile_id).newqrating),
          //$("#pide"+player.profile_id).html((fs(player.profile_id).newqrating*0.006-3).toFixed(1)),
          $("#pidelo"+player.profile_id).html(Number(player.newqrating-fs(player.profile_id).qrating)),
          $("#wins"+player.profile_id).html(fs(player.profile_id).wins),
          $("#loses"+player.profile_id).html(fs(player.profile_id).loses)
          $("#games"+player.profile_id).html(fs(player.profile_id).games),
          $("#streak"+player.profile_id).html(fs(player.profile_id).streak),
          $("#streakest"+player.profile_id).html(fs(player.profile_id).streakest),
          $("#wl"+player.profile_id).html((fs(player.profile_id).wins/fs(player.profile_id).games*100).toFixed(0)+"%" )
  
    }})
  
  }
function insertGames (pastGbMatches) {
  obj.forEach((player) => { if(player.status==1 || player.status==4 || player.status==5){
               player['qrating']=0
               player['games']=0
               player['wins']=0      
               player['loses']=0
               player['streak']=0 
               player['streakest']=0   
               $("#wins"+player.profile_id).html("0"),
               $("#loses"+player.profile_id).html("0")
               $("#games"+player.profile_id).html( "0"),
               $("#wl"+player.profile_id).html("0%" ),
               $("#pidr"+player.profile_id).html("0"),
               //$("#pide"+player.profile_id).html("0"),
               $("#pidcr"+player.profile_id).html("0"),
               //$("#pidce"+player.profile_id).html("0"),
               $("#streak"+player.profile_id).html("0"),
               $("#streakest"+player.profile_id).html("0")
               $("#"+player.profile_id).hide()
               }
              })
  pastGbMatches.sort(function(a, b){return a.match_id - b.match_id})    
  pastGbMatches.forEach((match) =>  {
        const teams = match['teams']
        const team1 = teams[0]
        const team2 = teams[1]
        const team1Player1 = teams[0][0]
        const team1Player2 = teams[0][1]
        const team1Player3 = teams[0][2]
        const team1Player4 = teams[0][3]
        const team2Player1 = teams[1][0]
        const team2Player2 = teams[1][1]
        const team2Player3 = teams[1][2]
        const team2Player4 = teams[1][3]
        if ((new Date(match['finished']).getTime()-new Date(match['started']).getTime())<600000 ) {
      
    } else {
       
        let team1won = 0
        let team2won = 0
        let team1streak =0
        let team2streak =0

        if (team1[0].won==true){
          team1won = 1
          team2won = 0
          team1streak =1
          team2streak =-1
        }
        else if(team1[0].won==false)
        {
          team1won = 0
          team2won = 1
          team1streak =-1
          team2streak =1
        }
        else{
          team1won = 0
          team2won = 0
          team1streak =0
          team2streak =0
        }
        team1.forEach((player) => {
          if ((fs(player.profile_id).streak>=0 && team1streak==1) || (fs(player.profile_id).streak<=0 && team1streak==-1) ){
            fs(player.profile_id).streak += team1streak
            
          }
          else if ((fs(player.profile_id).streak>=0 && team1streak==-1) || (fs(player.profile_id).streak<=0 && team1streak==1) ){
            fs(player.profile_id).streak = team1streak
          }
          if (Math.abs(fs(player.profile_id).streak) >= Math.abs(fs(player.profile_id).streakest )){
            fs(player.profile_id).streakest = fs(player.profile_id).streak
          }
          if(fs(player.profile_id).qrating==0){
            $("#"+player.profile_id).show()
            fs(player.profile_id).qrating=player.qrating
            $("#pidcr"+player.profile_id).html(fs(player.profile_id).qrating)
            //$("#pidce"+player.profile_id).html((fs(player.profile_id).qrating*0.006-3).toFixed(1))

          }
          $("#pidr"+player.profile_id).html(player.newqrating),
          //$("#pide"+player.profile_id).html((player.newqrating*0.006-3).toFixed(1)),
          $("#pidelo"+player.profile_id).html(Number(player.newqrating-fs(player.profile_id).qrating)),
          fs(player.profile_id).wins+=team1won,
          $("#wins"+player.profile_id).html(fs(player.profile_id).wins),
          fs(player.profile_id).loses+=team2won,
          $("#loses"+player.profile_id).html(fs(player.profile_id).loses)
          fs(player.profile_id).games=fs(player.profile_id).wins+fs(player.profile_id).loses,
          $("#games"+player.profile_id).html(fs(player.profile_id).games),
          $("#streak"+player.profile_id).html(fs(player.profile_id).streak),
          $("#streakest"+player.profile_id).html(fs(player.profile_id).streakest),
          $("#wl"+player.profile_id).html((fs(player.profile_id).wins/fs(player.profile_id).games*100).toFixed(0)+"%" )
        })
        team2.forEach((player) =>  {
          if ((fs(player.profile_id).streak>=0 && team2streak==1) || (fs(player.profile_id).streak<=0 && team2streak==-1) ){
            fs(player.profile_id).streak += team2streak
            
          }
          else if ((fs(player.profile_id).streak>=0 && team2streak==-1) || (fs(player.profile_id).streak<=0 && team2streak==1) ){
            fs(player.profile_id).streak = team2streak
          }
          if (Math.abs(fs(player.profile_id).streak) >= Math.abs(fs(player.profile_id).streakest )){
            fs(player.profile_id).streakest = fs(player.profile_id).streak
          }
          if(fs(player.profile_id).qrating==0){
            $("#"+player.profile_id).show()
            fs(player.profile_id).qrating=player.qrating
            $("#pidcr"+player.profile_id).html(fs(player.profile_id).qrating)
            //$("#pidce"+player.profile_id).html((fs(player.profile_id).qrating*0.006-3).toFixed(1))

          }
          $("#pidr"+player.profile_id).html(player.newqrating),
          //$("#pide"+player.profile_id).html((player.newqrating*0.006-3).toFixed(1)),
          $("#pidelo"+player.profile_id).html(Number(player.newqrating-fs(player.profile_id).qrating)),
          fs(player.profile_id).wins+=team2won,
          $("#wins"+player.profile_id).html(fs(player.profile_id).wins),
          fs(player.profile_id).loses+=team1won,
          $("#loses"+player.profile_id).html(fs(player.profile_id).loses)
          fs(player.profile_id).games=fs(player.profile_id).wins+fs(player.profile_id).loses,
          $("#games"+player.profile_id).html(fs(player.profile_id).games),
          $("#streak"+player.profile_id).html(fs(player.profile_id).streak),
          $("#streakest"+player.profile_id).html(fs(player.profile_id).streakest),
          $("#wl"+player.profile_id).html((fs(player.profile_id).wins/fs(player.profile_id).games*100).toFixed(0)+"%" )
        })
      }      
    })}  
    
    function myFunction() {
    var x=0
    var y=25
    
    y = document.getElementById("numb1").value;
    x = document.getElementById("numb2").value;
    matchs.sort(function(a, b){return b.match_id - a.match_id}) 
    var citrus = matchs.slice(matchs.length-x,matchs.length-y)
    insertGames (citrus)
    
    ss()
    console.info(obj)
    LiveGames (citrus)// 如果输入的值 x 不是数字或者小于 1 或者大于 10，则提示错误 Not a Number or less than one or greater than 10
    function  ss() {

$('#leaderboard-table').DataTable({
  "autoWidth": false,
    "searching": false, 
    "destroy": true,  
    "paging": false,
    "order": [[9, 'desc'], [2, 'desc']],

} );   
}
    }
    function myFunctiondate24() {
      var x =  Number(document.getElementById("numb24").value);
      matchesdate(x)
    }
    function myFunctiondate7() {
      var x =  Number(document.getElementById("numb7").value);
      matchesdate(x)
    }
    function myFunctiondate30() {
      var x =  Number(document.getElementById("numb30").value);
      matchesdate(x)
    }
    function myFunctiondate90() {
      var x =  Number(document.getElementById("numb90").value);
      matchesdate(x)
    }
    function myalb() {
      var x =  Number(document.getElementById("numb1").value);
      console.info(x)
      mapsdate("Arabia","[map_type.10875]")
    }
    function myjjc() {
      var x =  Number(document.getElementById("numb21").value);
      console.info(x)
      mapsdate("Arena","[map_type.10895]")
    }
    
    function myym() {
      mapsdate("Nomad","[map_type.10901]")
    }
    function myfl() {
      mapsdate("African Clearing","[map_type.10940]")
    }
    function myzczc() {
      mapsdate("Hideout","[map_type.10919]")
    }
    function mygcy() {
      mapsdate("Steppe","[map_type.10922]")
    }
    function myfwsq() {
      mapsdate("Runestones","[map_type.10958]")
    }
    function matchesdate(x) {
    var d1=new Date().getTime(); 
    
    var citrus = []
    matchs.forEach((match)=>{
      var d2 =new Date(match.started).getTime()
      if((d1-d2)<x*24*60*60*1000){
        citrus.push(match)
       }
    })
    if(citrus.length>0){

    citrus.sort(function(a, b){return a.match_id - b.match_id}) 
    insertGames (citrus)
    console.info(citrus)
    ss()
    console.info(obj)
    LiveGames (citrus)// 如果输入的值 x 不是数字或者小于 1 或者大于 10，则提示错误 Not a Number or less than one or greater than 10
    function  ss() {

$('#leaderboard-table').DataTable({
  "autoWidth": false,
    "searching": false, 
    "destroy": true,  
    "paging": false,
    "order": [[9, 'desc'], [2, 'desc']],

} );   
}
}}    
function mapsdate(x,y) {
    
    var citrus = []
    matchs.forEach((match)=>{
     
      if(match.map_name==x || match.map_name==y){
        citrus.push(match)
       }
    })
    if(citrus.length>0){

    citrus.sort(function(a, b){return a.match_id - b.match_id}) 
    insertGames (citrus)
    console.info(citrus)
    ss()
    console.info(obj)
    LiveGames (citrus)// 如果输入的值 x 不是数字或者小于 1 或者大于 10，则提示错误 Not a Number or less than one or greater than 10
    function  ss() {

$('#leaderboard-table').DataTable({
  "autoWidth": false,
    "searching": false, 
    "destroy": true,  
    "paging": false,
    "order": [[9, 'desc'], [2, 'desc']],

} );   
}
}}   

function matchQY() {
    
    
    var citrus = []
    matchs.forEach((match)=>{
      var l =0
      
      match.teams[0].forEach((p)=>{
        if(QYprofile_ids.includes(p.profile_id)){
                     l++;
                  }
      })
      match.teams[1].forEach((p)=>{
        if(QYprofile_ids.includes(p.profile_id)){
                     l++;
                  }
      })
      
      if(l>5){
        citrus.push(match)
       }
    })
    if(citrus.length>0){
    QYmatchs=citrus
    citrus.sort(function(a, b){return a.match_id - b.match_id}) 
    insertGames (citrus)
    console.info(citrus)
    ss()
    console.info(obj)
    LiveGames (citrus)// 如果输入的值 x 不是数字或者小于 1 或者大于 10，则提示错误 Not a Number or less than one or greater than 10
    function  ss() {

$('#leaderboard-table').DataTable({
  "autoWidth": false,
    "searching": false, 
    "destroy": true,  
    "paging": false,
    "order": [[9, 'desc'], [2, 'desc']],

} );   
}
}} 


function getnewmatches(profile_ids,page){
  
  
  var roomurl =" https://data.aoe2companion.com/api/matches?profile_ids="+profile_ids+"&search=&leaderboard_ids=&page="+page;     
  $.get(roomurl, function (res) {
            var result = res.matches;
            console.log(result)
            result.forEach((match) => {
              if(match.match_id > matchs[0].match_id  && match.teams.length==2){
                var p=[]
                match.teams[0].forEach((player)=>{
                  if(profile_ids.includes(player.profile_id)){
                      p.push(1)
                  }
                  else{
                      p.push(0)
                  }
                 
                   });
                   match.teams[1].forEach((player)=>{
                    if(profile_ids.includes(player.profile_id)){
                        p.push(1)
                    }
                    else{
                        p.push(0)
                    }
                   
                     });
                   var psum =0
                   p.forEach((pnumber)=>{psum +=pnumber})
                   
                if (psum==8 && match.finished!=null) {
                newmatches.push(match)
              }
            }}) 
            newmatches.sort(function(a, b){return a.match_id - b.match_id})
            insertLiveGames (newmatches)
            matchs = matchs.concat(newmatches)
            $("#games").html(matchs.length),
            LiveGames (matchs)
     
    })
}
function getunrankmatches(profile_ids){
  matchs.sort(function(a, b){return a.match_id - b.match_id})
  var d1=new Date().getTime();
  var d2=new Date(matchs[matchs.length-1]['started']).getTime()
  var time = Math.round((d1-d2)/(1000*60*60*24))+2
  
  console.log(time)
  var resultmatches=[]
 
    $.ajaxSettings.async = false;
  for(var i=1;i<=time;i++){
    
  var roomurl =" https://data.aoe2companion.com/api/matches?profile_ids="+profile_ids+"&search=&leaderboard_ids=unranked&page="+i;     
  $.get(roomurl, function (res) {
       var result = res.matches;
       
       resultmatches=resultmatches.concat(result)
       console.log(resultmatches)
       
      })
        
       
      }
      $.ajaxSettings.async = true;
    
    
      
       console.log(resultmatches)
       resultmatches.sort(function(a, b){return a.matchId - b.matchId})
       
       
       
       resultmatches.forEach((match) => {
          
       if(match.matchId> matchs[matchs.length-1].match_id){
                var p=[]
                match['match_id']=match.matchId
                match['map_image_url']=match.mapImageUrl
                match['map_name']=match.mapName
                match['leaderboard_id']=match.leaderboardId
                match.players=[]
                match.teams1=[]
                match.teams2=[]
                match.teams1[0]=[]
                match.teams1[1]=[]
                if( match.teams.length==2){
                match.teams[0].players.forEach((player)=>{
                  player['profile_id']=player.profileId
                  player['civ_name']=player.civName
                  match.players.push(player)
                  match.teams1[0].push(player)
                 });
                match.teams[1].players.forEach((player)=>{
                  player['profile_id']=player.profileId
                  player['civ_name']=player.civName
                  match.players.push(player)
                  match.teams1[1].push(player)}
                   ); 
                 }
                 if( match.teams.length==1){
                   match.teams[0].players.forEach((player)=>{
                     player['profile_id']=player.profileId
                     player['civ_name']=player.civName
                     match.players.push(player)
                     match.teams1[0].push(player)
                    });
                   
                    }  
                    match.teams2=match.teams
                    match.teams=match.teams1
                    console.log(match)   
                match.players.forEach((player)=>{
                    if(profile_ids.includes(player.profile_id)){
                     
                       p.push(1)
                       }
                     else{
                       p.push(0)
                       }
                    });
                
               var psum =0
               p.forEach((pnumber)=>{psum +=pnumber})
               
                    if(psum==8 && match.finished!=null && newmatches.includes(match)==false){
                             newmatches.push(match)
                             insertLiveGames ([match])
                         }
                      
                 
             
           }
         })

         console.log(newmatches)
         matchs = matchs.concat(newmatches)
         playerdata=obj
         //matchQY()
         $("#games").html(matchs.length)
         LiveGames (matchs)
         function  ss() {

$('#leaderboard-table').DataTable({
  "autoWidth": false,
    "searching": false, 
    "destroy": true,  
    "paging": false,
    "order": [[9, 'desc'], [2, 'desc']],

} );   
}
      
}

</script>
</body>
</html>